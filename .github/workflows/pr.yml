name: Pull Request CI

on:
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'

jobs:
  # Quick validation for PRs
  validate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linter
      run: npm run lint

    - name: Check TypeScript compilation
      run: npm run build

    - name: Run unit tests
      run: npm run test:unit
      env:
        NODE_ENV: test

    - name: Run security audit
      run: npm audit --audit-level=moderate

  # Comment on PR with test results
  comment:
    runs-on: ubuntu-latest
    needs: validate
    if: always()
    steps:
    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.login === 'github-actions[bot]' && 
            comment.body.includes('ğŸ¤– PR Validation Results')
          );
          
          const status = '${{ needs.validate.result }}';
          const statusEmoji = status === 'success' ? 'âœ…' : 'âŒ';
          const body = `ğŸ¤– PR Validation Results ${statusEmoji}
          
          **Status:** ${status.toUpperCase()}
          
          ${status === 'success' ? 
            '- âœ… Linting passed\n- âœ… TypeScript compilation successful\n- âœ… Unit tests passed\n- âœ… Security audit clean' :
            '- âŒ One or more validation steps failed\n- Check the [workflow run](${context.payload.pull_request.html_url}/checks) for details'
          }
          
          <sub>Updated: ${new Date().toUTCString()}</sub>`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }